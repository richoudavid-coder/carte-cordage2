<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Cartes Cordage Pro</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        firebase.initializeApp({
            apiKey: "AIzaSyAiaN21dc4giFqIXs73y2FdoWfUY8OMeMc",
            authDomain: "cartes-cordage.firebaseapp.com",
            projectId: "cartes-cordage",
            storageBucket: "cartes-cordage.firebasestorage.app",
            messagingSenderId: "97320852158",
            appId: "1:97320852158:web:0033c473b155f08788dcef"
        });
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        function App() {
            const [clients, setClients] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingClientId, setEditingClientId] = useState(null);
            const [syncStatus, setSyncStatus] = useState('‚òÅÔ∏è');
            const [lastBackup, setLastBackup] = useState(null);
            const [autoBackupEnabled, setAutoBackupEnabled] = useState(true);
            const [newClient, setNewClient] = useState({ nom: '', prenom: '', telephone: '', email: '' });

            // Chargement des donn√©es
            useEffect(() => {
                const unsubscribe = db.collection('clients').onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setClients(data.sort((a, b) => new Date(b.dateCreation) - new Date(a.dateCreation)));
                    setSyncStatus('‚òÅÔ∏è Sync');
                });
                
                // Charger la date de derni√®re sauvegarde
                const savedBackupDate = localStorage.getItem('lastBackupDate');
                if (savedBackupDate) {
                    setLastBackup(new Date(savedBackupDate));
                }
                
                return () => unsubscribe();
            }, []);

            // Sauvegarde automatique toutes les 24h
            useEffect(() => {
                if (!autoBackupEnabled || clients.length === 0) return;

                const checkAutoBackup = () => {
                    const now = new Date();
                    if (!lastBackup || (now - lastBackup) > 24 * 60 * 60 * 1000) {
                        handleAutoBackup();
                    }
                };

                // V√©rifier au chargement et toutes les heures
                checkAutoBackup();
                const interval = setInterval(checkAutoBackup, 60 * 60 * 1000);
                return () => clearInterval(interval);
            }, [clients, lastBackup, autoBackupEnabled]);

            const saveClient = async (client) => {
                await db.collection('clients').doc(client.id).set(client);
            };

            const handleAutoBackup = () => {
                const backup = {
                    version: '1.0',
                    dateExport: new Date().toISOString(),
                    clients: clients,
                    stats: {
                        totalClients: clients.length,
                        totalCartes: clients.reduce((s, c) => s + (c.cartes?.length || 0), 0),
                        totalPoses: clients.reduce((s, c) => s + c.cartes?.reduce((x, carte) => x + carte.poses.filter(p => p).length, 0) || 0, 0)
                    }
                };

                localStorage.setItem('autoBackup', JSON.stringify(backup));
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                setLastBackup(new Date());
            };

            const handleExport = () => {
                const backup = {
                    version: '1.0',
                    dateExport: new Date().toISOString(),
                    clients: clients,
                    stats: {
                        totalClients: clients.length,
                        totalCartes: clients.reduce((s, c) => s + (c.cartes?.length || 0), 0),
                        totalPoses: clients.reduce((s, c) => s + c.cartes?.reduce((x, carte) => x + carte.poses.filter(p => p).length, 0) || 0, 0)
                    }
                };

                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cordage-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                // Mettre √† jour la date de sauvegarde
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                setLastBackup(new Date());
                
                alert(`‚úÖ Sauvegarde r√©ussie !\n\nüìä Statistiques :\n‚Ä¢ ${backup.stats.totalClients} clients\n‚Ä¢ ${backup.stats.totalCartes} cartes\n‚Ä¢ ${backup.stats.totalPoses} poses`);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const backup = JSON.parse(ev.target.result);
                        
                        // V√©rifier la structure
                        if (!backup.clients || !Array.isArray(backup.clients)) {
                            alert('‚ùå Format de fichier invalide');
                            return;
                        }

                        const stats = backup.stats || {
                            totalClients: backup.clients.length,
                            totalCartes: backup.clients.reduce((s, c) => s + (c.cartes?.length || 0), 0),
                            totalPoses: backup.clients.reduce((s, c) => s + c.cartes?.reduce((x, carte) => x + carte.poses.filter(p => p).length, 0) || 0, 0)
                        };

                        const confirmMsg = `Restaurer cette sauvegarde ?\n\nüìä Contenu :\n‚Ä¢ ${stats.totalClients} clients\n‚Ä¢ ${stats.totalCartes} cartes\n‚Ä¢ ${stats.totalPoses} poses\n\n‚ö†Ô∏è Les donn√©es actuelles seront remplac√©es`;
                        
                        if (confirm(confirmMsg)) {
                            // Supprimer toutes les donn√©es actuelles
                            const currentClients = await db.collection('clients').get();
                            const batch = db.batch();
                            currentClients.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();

                            // Restaurer les donn√©es
                            for (const client of backup.clients) {
                                await db.collection('clients').doc(client.id).set(client);
                            }
                            
                            alert('‚úÖ Restauration r√©ussie !');
                        }
                    } catch (error) {
                        console.error(error);
                        alert('‚ùå Erreur lors de la restauration');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            };

            const addClient = async () => {
                if (!newClient.nom || !newClient.prenom) return alert('Nom et pr√©nom requis');
                await saveClient({ 
                    id: Date.now().toString(), 
                    ...newClient, 
                    cartes: [], 
                    dateCreation: new Date().toISOString() 
                });
                setNewClient({ nom: '', prenom: '', telephone: '', email: '' });
                setShowAddForm(false);
            };

            const togglePose = async (cid, ci, pi) => {
                const client = clients.find(c => c.id === cid);
                const updated = { ...client };
                if (updated.cartes[ci].poses[pi]) {
                    updated.cartes[ci].poses[pi] = null;
                } else {
                    updated.cartes[ci].poses[pi] = { 
                        date: new Date().toISOString(), 
                        cordage: '', 
                        tension: '' 
                    };
                    const used = updated.cartes[ci].poses.filter(p => p).length;
                    if (10 - used === 3) alert(`‚ö†Ô∏è Il reste 3 poses`);
                    if (used === 10) alert('‚úÖ Carte compl√®te !');
                }
                await saveClient(updated);
            };

            const addCarte = async (cid, sport) => {
                const c = clients.find(x => x.id === cid);
                await saveClient({ 
                    ...c, 
                    cartes: [...(c.cartes || []), { 
                        id: Date.now().toString(), 
                        sport, 
                        dateAchat: new Date().toISOString(), 
                        poses: Array(10).fill(null) 
                    }] 
                });
            };

            const delClient = async (cid) => {
                if (confirm('‚ö†Ô∏è Supprimer ce client et toutes ses cartes ?')) {
                    await db.collection('clients').doc(cid).delete();
                }
            };

            const delCarte = async (cid, ci) => {
                if (confirm('‚ö†Ô∏è Supprimer cette carte ?')) {
                    const c = clients.find(x => x.id === cid);
                    await saveClient({ ...c, cartes: c.cartes.filter((_, i) => i !== ci) });
                }
            };

            const updatePose = async (cid, ci, pi, field, val) => {
                const c = clients.find(x => x.id === cid);
                const u = { ...c };
                if (u.cartes[ci].poses[pi]) {
                    u.cartes[ci].poses[pi][field] = val;
                    await saveClient(u);
                }
            };

            const filtered = clients.filter(c => {
                const s = searchTerm.toLowerCase();
                return c.nom.toLowerCase().includes(s) || 
                       c.prenom.toLowerCase().includes(s) || 
                       (c.telephone?.includes(s)) || 
                       (c.email?.toLowerCase().includes(s));
            });

            const formatDate = (date) => {
                if (!date) return 'Jamais';
                const d = new Date(date);
                const now = new Date();
                const diff = now - d;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                
                if (hours < 1) return 'Il y a moins d\'1h';
                if (hours < 24) return `Il y a ${hours}h`;
                const days = Math.floor(hours / 24);
                if (days === 1) return 'Hier';
                if (days < 7) return `Il y a ${days} jours`;
                return d.toLocaleDateString('fr-FR');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-xl p-6 mb-6">
                            <div className="flex flex-col gap-4">
                                <div className="flex justify-between items-center">
                                    <h1 className="text-3xl font-bold">Cartes Cordage Pro</h1>
                                    <span className="bg-green-100 text-green-700 px-3 py-1 rounded text-sm">{syncStatus}</span>
                                </div>
                                
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-semibold text-blue-900">üíæ Sauvegarde automatique</h3>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                checked={autoBackupEnabled}
                                                onChange={(e) => setAutoBackupEnabled(e.target.checked)}
                                                className="w-4 h-4"
                                            />
                                            <span className="text-sm">Activ√©e</span>
                                        </label>
                                    </div>
                                    <p className="text-sm text-gray-600">
                                        Derni√®re sauvegarde : {formatDate(lastBackup)}
                                    </p>
                                </div>

                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={handleExport} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                                        üíæ Exporter
                                    </button>
                                    <label className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded cursor-pointer transition">
                                        üì§ Importer
                                        <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                    </label>
                                    <button onClick={() => setShowAddForm(!showAddForm)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded ml-auto transition">
                                        + Nouveau Client
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                                <div className="bg-blue-100 p-4 rounded">
                                    <p className="text-sm text-gray-600">Clients</p>
                                    <p className="text-2xl font-bold">{clients.length}</p>
                                </div>
                                <div className="bg-green-100 p-4 rounded">
                                    <p className="text-sm text-gray-600">üéæ Tennis</p>
                                    <p className="text-2xl font-bold">
                                        {clients.reduce((s, c) => s + (c.cartes?.filter(x => x.sport === 'tennis').length || 0), 0)}
                                    </p>
                                </div>
                                <div className="bg-orange-100 p-4 rounded">
                                    <p className="text-sm text-gray-600">üè∏ Badminton</p>
                                    <p className="text-2xl font-bold">
                                        {clients.reduce((s, c) => s + (c.cartes?.filter(x => x.sport === 'badminton').length || 0), 0)}
                                    </p>
                                </div>
                                <div className="bg-purple-100 p-4 rounded">
                                    <p className="text-sm text-gray-600">Total Poses</p>
                                    <p className="text-2xl font-bold">
                                        {clients.reduce((s, c) => s + (c.cartes?.reduce((x, carte) => x + carte.poses.filter(p => p).length, 0) || 0), 0)}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow p-4 mb-6">
                            <input 
                                type="text" 
                                placeholder="üîç Rechercher un client..." 
                                value={searchTerm} 
                                onChange={(e) => setSearchTerm(e.target.value)} 
                                className="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            />
                        </div>

                        {showAddForm && (
                            <div className="bg-white rounded-xl shadow-xl p-6 mb-6">
                                <h2 className="text-xl font-bold mb-4">Nouveau Client</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <input 
                                        placeholder="Nom *" 
                                        value={newClient.nom} 
                                        onChange={(e) => setNewClient({...newClient, nom: e.target.value})} 
                                        className="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    />
                                    <input 
                                        placeholder="Pr√©nom *" 
                                        value={newClient.prenom} 
                                        onChange={(e) => setNewClient({...newClient, prenom: e.target.value})} 
                                        className="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    />
                                    <input 
                                        placeholder="T√©l√©phone" 
                                        value={newClient.telephone} 
                                        onChange={(e) => setNewClient({...newClient, telephone: e.target.value})} 
                                        className="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    />
                                    <input 
                                        placeholder="Email" 
                                        value={newClient.email} 
                                        onChange={(e) => setNewClient({...newClient, email: e.target.value})} 
                                        className="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={addClient} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition">
                                        ‚úÖ Cr√©er
                                    </button>
                                    <button onClick={() => setShowAddForm(false)} className="bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded transition">
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="space-y-4">
                            {filtered.map(client => (
                                <div key={client.id} className="bg-white rounded-xl shadow-xl p-6">
                                    <div className="flex justify-between mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold">{client.prenom} {client.nom}</h3>
                                            {client.telephone && <p className="text-sm text-gray-600">üì± {client.telephone}</p>}
                                            {client.email && <p className="text-sm text-gray-600">üìß {client.email}</p>}
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => addCarte(client.id, 'tennis')} 
                                                className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition"
                                                title="Ajouter carte tennis"
                                            >
                                                üéæ
                                            </button>
                                            <button 
                                                onClick={() => addCarte(client.id, 'badminton')} 
                                                className="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition"
                                                title="Ajouter carte badminton"
                                            >
                                                üè∏
                                            </button>
                                            <button 
                                                onClick={() => delClient(client.id)} 
                                                className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition"
                                                title="Supprimer client"
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                    <div className="space-y-3">
                                        {client.cartes?.map((carte, ci) => {
                                            const used = carte.poses.filter(p => p).length;
                                            const isTennis = carte.sport === 'tennis';
                                            return (
                                                <div key={carte.id} className={`border-2 rounded-lg p-4 ${isTennis ? 'bg-green-50 border-green-200' : 'bg-orange-50 border-orange-200'}`}>
                                                    <div className="flex justify-between mb-3">
                                                        <div>
                                                            <span className="font-bold">{isTennis ? 'üéæ' : 'üè∏'} Carte #{ci + 1}</span>
                                                            <p className="text-xs text-gray-500">
                                                                Cr√©√©e le {new Date(carte.dateAchat).toLocaleDateString('fr-FR')}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2 items-center">
                                                            <span className="text-sm font-bold bg-white px-2 py-1 rounded">{used}/10</span>
                                                            <button 
                                                                onClick={() => delCarte(client.id, ci)} 
                                                                className="text-red-600 hover:text-red-800 text-sm transition"
                                                                title="Supprimer carte"
                                                            >
                                                                üóëÔ∏è
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-5 gap-2">
                                                        {carte.poses.map((pose, pi) => (
                                                            <div key={pi}>
                                                                <button 
                                                                    onClick={() => togglePose(client.id, ci, pi)} 
                                                                    className={`w-full p-2 rounded text-xs font-semibold transition ${
                                                                        pose 
                                                                            ? (isTennis ? 'bg-green-500 hover:bg-green-600' : 'bg-orange-500 hover:bg-orange-600') + ' text-white' 
                                                                            : 'bg-white border hover:bg-gray-50'
                                                                    }`}
                                                                >
                                                                    {pose ? '‚úì' : '‚óã'} {pi + 1}
                                                                </button>
                                                                {pose && (
                                                                    <div className="mt-1 space-y-1">
                                                                        <input 
                                                                            placeholder="Cordage" 
                                                                            value={pose.cordage || ''} 
                                                                            onChange={(e) => updatePose(client.id, ci, pi, 'cordage', e.target.value)} 
                                                                            className="w-full text-xs border rounded px-1 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                                                        />
                                                                        <input 
                                                                            placeholder="Tension" 
                                                                            value={pose.tension || ''} 
                                                                            onChange={(e) => updatePose(client.id, ci, pi, 'tension', e.target.value)} 
                                                                            className="w-full text-xs border rounded px-1 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                                                        />
                                                                        <p className="text-xs text-gray-500">
                                                                            {new Date(pose.date).toLocaleDateString('fr-FR')}
                                                                        </p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {used === 7 && (
                                                        <div className="mt-2 bg-yellow-100 border border-yellow-400 rounded p-2 text-center text-xs font-semibold">
                                                            ‚ö†Ô∏è Plus que 3 poses restantes
                                                        </div>
                                                    )}
                                                    {used === 10 && (
                                                        <div className="mt-2 bg-green-100 border border-green-400 rounded p-2 text-center text-xs font-semibold">
                                                            ‚úÖ Carte compl√®te !
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                            
                            {filtered.length === 0 && (
                                <div className="bg-white rounded-xl shadow p-8 text-center text-gray-500">
                                    {searchTerm ? 'üîç Aucun client trouv√©' : 'üìù Aucun client enregistr√©'}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
